<!DOCTYPE html>
<html>
<head>
	<meta name="keywords" content="JavaScript, WebRTC, jsconf" />
	<meta name="description" content="Taller WebRTC" />
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1">

	<title>Taller de webrtc</title>
	<style>
	</style>
</head>

<body>

	<textarea id="dataChannelSend" disabled placeholder="Click en empezar, ingrese algun texto y luego click en enviar."></textarea>
	<textarea id="dataChannelReceive" disabled></textarea>

	<div id="buttons">
		<button id="startButton">Empezar</button>
		<button id="sendButton">Enviar</button>
		<button id="closeButton">Detener</button>
	</div>

	<script>
		var sendChannel, receiveChannel;

		var startButton = document.getElementById("startButton");
		var sendButton = document.getElementById("sendButton");
		var closeButton = document.getElementById("closeButton");
		startButton.disabled = false;
		sendButton.disabled = true;
		closeButton.disabled = true;
		startButton.onclick = createConnection;
		sendButton.onclick = sendData;
		closeButton.onclick = closeDataChannels;

		function trace(text) {
			console.log((performance.now() / 1000).toFixed(3) + ": " + text);
		}

		function createConnection() {
			var servers = null;
			window.localPeerConnection = new webkitRTCPeerConnection(servers,
				{optional: [{RtpDataChannels: true}]});
			trace('Creado: local peer connection object localPeerConnection');

			try {
				// Reliable Data Channels not yet supported in Chrome
				sendChannel = localPeerConnection.createDataChannel("sendDataChannel",
					{reliable: false});
				trace('Canal de envio de datos creado.');
			} catch (e) {
				alert('Fallo al crear canal de datos. ' +
							'Necesitas Chrome M25 o posterior con RtpDataChannel enabled');
				trace('createDataChannel() failed with exception: ' + e.message);
			}
			localPeerConnection.onicecandidate = gotLocalCandidate;
			sendChannel.onopen = handleSendChannelStateChange;
			sendChannel.onclose = handleSendChannelStateChange;

			window.remotePeerConnection = new webkitRTCPeerConnection(servers,
				{optional: [{RtpDataChannels: true}]});
			trace('Creado: remote peer connection object remotePeerConnection');

			remotePeerConnection.onicecandidate = gotRemoteIceCandidate;
			remotePeerConnection.ondatachannel = gotReceiveChannel;

			localPeerConnection.createOffer(gotLocalDescription);
			startButton.disabled = true;
			closeButton.disabled = false;
		}

		function sendData() {
			var data = document.getElementById("dataChannelSend").value;
			sendChannel.send(data);
			trace('Sent data: ' + data);
		}

		function closeDataChannels() {
			trace('Cerrando los canales de datos');
			sendChannel.close();
			trace('Cerrando los canales de datos con etiqueta: ' + sendChannel.label);
			receiveChannel.close();
			trace('canales de datos cerrados con etiqueta: ' + receiveChannel.label);
			localPeerConnection.close();
			remotePeerConnection.close();
			localPeerConnection = null;
			remotePeerConnection = null;
			trace('Cerrado conexiones de puntos');
			startButton.disabled = false;
			sendButton.disabled = true;
			closeButton.disabled = true;
			dataChannelSend.value = "";
			dataChannelReceive.value = "";
			dataChannelSend.disabled = true;
			dataChannelSend.placeholder = "Click en empezar, ingrese alg√∫n texto y luego presione enviar.";
		}

		function gotLocalDescription(desc) {
			localPeerConnection.setLocalDescription(desc);
			trace('Oferta desde localPeerConnection \n' + desc.sdp);
			remotePeerConnection.setRemoteDescription(desc);
			remotePeerConnection.createAnswer(gotRemoteDescription);
		}

		function gotRemoteDescription(desc) {
			remotePeerConnection.setLocalDescription(desc);
			trace('Respuesta desde remotePeerConnection \n' + desc.sdp);
			localPeerConnection.setRemoteDescription(desc);
		}

		function gotLocalCandidate(event) {
			trace('local ice callback');
			if (event.candidate) {
				remotePeerConnection.addIceCandidate(event.candidate);
				trace('Local ICE candidate: \n' + event.candidate.candidate);
			}
		}

		function gotRemoteIceCandidate(event) {
			trace('remote ice callback');
			if (event.candidate) {
				localPeerConnection.addIceCandidate(event.candidate);
				trace('Remote ICE candidate: \n ' + event.candidate.candidate);
			}
		}

		function gotReceiveChannel(event) {
			trace('Receive Channel Callback');
			receiveChannel = event.channel;
			receiveChannel.onmessage = handleMessage;
			receiveChannel.onopen = handleReceiveChannelStateChange;
			receiveChannel.onclose = handleReceiveChannelStateChange;
		}

		function handleMessage(event) {
			trace('Mensaje recibido: ' + event.data);
			document.getElementById("dataChannelReceive").value = event.data;
		}

		function handleSendChannelStateChange() {
			var readyState = sendChannel.readyState;
			trace('Estado del canal de envio es: ' + readyState);
			if (readyState == "open") {
				dataChannelSend.disabled = false;
				dataChannelSend.focus();
				dataChannelSend.placeholder = "";
				sendButton.disabled = false;
				closeButton.disabled = false;
			} else {
				dataChannelSend.disabled = true;
				sendButton.disabled = true;
				closeButton.disabled = true;
			}
		}

		function handleReceiveChannelStateChange() {
			var readyState = receiveChannel.readyState;
			trace('Estado del canal de recibido es: ' + readyState);
		}
	</script>

</body>

</html>