<!DOCTYPE html>
<html>
<head>
	<meta name="keywords" content="JavaScript, WebRTC, jsconf" />
	<meta name="description" content="Taller WebRTC" />
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1">

	<title>Taller de webrtc</title>
	<style>
	</style>
</head>

<body>

	<video id="myVideo" autoplay muted controls></video>
	<video id="remoteVideo" autoplay muted controls></video>

	<div>
		<button id="startButton">Empezar</button>
		<button id="callButton">Llamar</button>
		<button id="hangupButton">Colgar</button>
	</div>

	<script>
		var localStream, localPeerConnection, remotePeerConnection;

		var myVideo = document.getElementById("myVideo");
		var remoteVideo = document.getElementById("remoteVideo");

		var startButton = document.getElementById("startButton");
		var callButton = document.getElementById("callButton");
		var hangupButton = document.getElementById("hangupButton");
		startButton.disabled = false;
		callButton.disabled = true;
		hangupButton.disabled = true;
		startButton.onclick = start;
		callButton.onclick = call;
		hangupButton.onclick = hangup;

		function trace(text) {
			console.log((performance.now() / 1000).toFixed(3) + ": " + text);
		}

		function gotStream(stream){
			trace("Stream local recibido");
			myVideo.src = window.URL.createObjectURL(stream);
			localStream = stream;
			callButton.disabled = false;
		}

		function start() {
			trace("Solicitando stream local");
			startButton.disabled = true;
			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
			navigator.getUserMedia({video:true, audio:true}, 
									gotStream,
									function(error) {
										trace("navigator.getUserMedia error: ", error);
									});
		}

		function call() {
			callButton.disabled = true;
			hangupButton.disabled = false;
			trace("Comenzando llamada");

			if (localStream.getVideoTracks().length > 0) {
				trace('Usando el dispositivo de video: ' + localStream.getVideoTracks()[0].label);
			}
			if (localStream.getAudioTracks().length > 0) {
				trace('Usando el dispositivo de audio: ' + localStream.getAudioTracks()[0].label);
			}

			var servers = null;

			localPeerConnection = new webkitRTCPeerConnection(servers);
			trace("Creado peer local: localPeerConnection");
			localPeerConnection.onicecandidate = gotLocalIceCandidate;

			remotePeerConnection = new webkitRTCPeerConnection(servers);
			trace("Creado peer remoto: remotePeerConnection");
			remotePeerConnection.onicecandidate = gotRemoteIceCandidate;
			remotePeerConnection.onaddstream = gotRemoteStream;

			localPeerConnection.addStream(localStream);
			trace("se ha agregado localStream a localPeerConnection");
			localPeerConnection.createOffer(gotLocalDescription);
		}

		function gotLocalDescription(description){
			localPeerConnection.setLocalDescription(description);
			trace("Oferta desde localPeerConnection: \n" + description.sdp);
			remotePeerConnection.setRemoteDescription(description);
			remotePeerConnection.createAnswer(gotRemoteDescription);
		}

		function gotRemoteDescription(description){
			remotePeerConnection.setLocalDescription(description);
			trace("Respuesta desde remotePeerConnection: \n" + description.sdp);
			localPeerConnection.setRemoteDescription(description);
		}

		function hangup() {
			trace("terminando llamada");
			localPeerConnection.close();
			remotePeerConnection.close();
			localPeerConnection = null;
			remotePeerConnection = null;
			hangupButton.disabled = true;
			callButton.disabled = false;
		}

		function gotRemoteStream(event){
			remoteVideo.src = URL.createObjectURL(event.stream);
			trace("Stream remoto recibido");
		}

		function gotLocalIceCandidate(event){
			if (event.candidate) {
				remotePeerConnection.addIceCandidate(new RTCIceCandidate(event.candidate));
				trace("Local ICE candidate: \n" + event.candidate.candidate);
			}
		}

		function gotRemoteIceCandidate(event){
			if (event.candidate) {
				localPeerConnection.addIceCandidate(new RTCIceCandidate(event.candidate));
				trace("Remote ICE candidate: \n " + event.candidate.candidate);
			}
		}
	</script>

</body>

</html>